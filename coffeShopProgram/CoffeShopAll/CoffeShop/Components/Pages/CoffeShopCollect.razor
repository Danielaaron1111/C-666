@*
========================================================================
DATA COLLECTION PAGE - Coffee Shop Orders
========================================================================
PURPOSE: Form to collect coffee order data and save to CSV file
EXAM TIP: This is your standard "CREATE" page pattern
Key Components:
1. Form inputs (text, dropdowns, numbers)
2. Validation (check data before saving)
3. File I/O (write to CSV)
4. Navigation (redirect after save)
========================================================================
*@

@page "/coffeshopcollect"
<PageTitle>CoffeshopCollect</PageTitle>
@rendermode InteractiveServer
@using CoffeeShopSystem

<h3>Coffee Shop Order Collection</h3>

@*
========================================================================
ERROR DISPLAY SECTION
========================================================================
Shows validation errors in red box with list of problems
EXAM TIP: Dictionary<int, string> = unique key (int) + error message (string)
*@
@if (errorMsgs.Count > 0)
{
    <div class="row alert alert-danger">
        <p><strong>Please fix the following issues:</strong></p>
        <ul>
            @foreach (var error in errorMsgs)
            {
                @* Display only the message part (Value), not the key *@
                <li>@error.Value</li>
            }
        </ul>
    </div>
}

<style>
    legend {
        text-align: center;
    }
</style>

<fieldset>
    <legend>Coffee Shop Order Form</legend>
    <h4>Order details</h4>
    
    @*
    ====================================================================
    ORDER ID INPUT - Text field
    ====================================================================
    @bind="orderId" creates TWO-WAY binding:
    - Display: Shows current value of orderId variable
    - Input: Updates orderId variable when user types
    EXAM TIP: @bind is the key to Blazor forms!
    ====================================================================
    *@
    <div class="row">
        <div class="offset-3 col-md-2">
            <label for="orderid">Order ID: </label>
        </div>
        <div class="col-md-3">
            <input type="text"
                   id="orderid"
                   placeholder="ORD001"
                   @bind="orderId" />
        </div>
    </div>
    <br />
    
    @*
    ====================================================================
    CUSTOMER NAME INPUT - Text field
    ====================================================================
    *@
    <div class="row">
        <div class="offset-3 col-md-2">
            <label for="customerName">Customer Name:</label>
        </div>
        <div class="col-md-3">
            <input type="text"
                   id="customerName"
                   placeholder="John Smith"
                   @bind="customerName" />
        </div>
    </div>
    <br />

    @*
    ====================================================================
    COFFEE SIZE DROPDOWN - Enum selection
    ====================================================================
    EXAM TIP: Dropdown pattern for NULLABLE enum:
    1. Add default "-- Select --" option with empty value
    2. Loop through enum values with @foreach
    3. Bind to NULLABLE variable (CoffeeSize?)
    4. Validate with .HasValue check
    ====================================================================
    *@
    <div class="row">
        <div class="col-md-4">
            <label for="coffesize">Coffee Size</label>
        </div>
        <div class="col-md-4">
            <select id="coffesize" @bind="coffesize">
                @* Default option - binds to null when selected *@
                <option value="">-- Select Size --</option>
                
                @* Loop through all enum values to create dropdown options *@
                @* Enum.GetValues gets all possible values from CoffeeSize enum *@
                @foreach (var item in Enum.GetValues(typeof(CoffeeSize)))
                {
                    <option value="@item">@item</option>
                }
            </select>
        </div>
    </div>
    <br />

    @*
    ====================================================================
    COFFEE TYPE DROPDOWN - Enum selection (same pattern as Size)
    ====================================================================
    *@
    <div class="row">
        <div class="col-md-4">
            <label for="coffetype">Coffee Type</label>
        </div>
        <div class="col-md-4">
            <select id="coffetype" @bind="coffetype">
                <option value="">-- Select Type --</option>
                @foreach (var item in Enum.GetValues(typeof(CoffeeType)))
                {
                    <option value="@item">@item</option>
                }
            </select>
        </div>
    </div>
    <br />

    @*
    ====================================================================
    QUANTITY INPUT - Number field
    ====================================================================
    type="number" gives up/down arrows and numeric keyboard on mobile
    ====================================================================
    *@
    <div class="row">
        <div class="col-md-4">
            <label for="quantity">Quantity:</label>
        </div>
        <div class="col-md-4">
            <input type="number"
                   id="quantity"
                   style="width: 100px;"
                   @bind="quantity" />
        </div>
    </div>
    <br />

    @*
    ====================================================================
    PRICE INPUT - Number field for decimal values
    ====================================================================
    *@
    <div class="row">
        <div class="col-md-4">
            <label for="price">Price:</label>
        </div>
        <div class="col-md-4">
            <input type="number"
                   id="price"
                   step="0.01"
                   style="width: 100px;"
                   @bind="price" />
        </div>
    </div>
    <br />

    @*
    ====================================================================
    ACTION BUTTONS
    ====================================================================
    @onclick triggers C# methods when clicked
    EXAM TIP: Button types:
    - Primary (blue) = main action (Record)
    - Secondary (gray) = secondary action (Clear)
    - Success (green) = navigation (Report)
    ====================================================================
    *@
    <div class="row">
        <div class="col-md-12 text-center">
            <button type="button" class="btn btn-primary"
                    @onclick="OnRecord">
                Record
            </button>
            &nbsp;&nbsp;
            <button type="button" class="btn btn-secondary"
                    @onclick="OnClear">
                Clear
            </button>
            &nbsp;&nbsp;
            <button type="button" class="btn btn-success"
                    @onclick="OnReport">
                Report
            </button>
        </div>
    </div>
</fieldset>

@*
========================================================================
CODE SECTION - C# logic for the page
========================================================================
EXAM TIP: This is where all your C# variables and methods go
========================================================================
*@
@code {
    // ====================================================================
    // VARIABLES - hold form data and errors
    // ====================================================================
    
    /// <summary>
    /// Dictionary to store error messages
    /// Key (int) = unique error number (1, 2, 3, etc.)
    /// Value (string) = error message to display
    /// EXAM TIP: Dictionary prevents duplicate keys, ensures unique errors
    /// </summary>
    private Dictionary<int, string> errorMsgs = new();

    /// <summary>
    /// Form field variables - bound to inputs with @bind
    /// EXAM TIP: Initialize strings to "" and numbers to 0
    /// </summary>
    private string orderId = "";
    private string customerName = "";
    
    /// <summary>
    /// Nullable enums for dropdowns - allows null to represent "not selected"
    /// CoffeeType? means "CoffeeType OR null"
    /// EXAM TIP: Use nullable (?) for dropdowns with "Select..." option
    /// </summary>
    private CoffeeType? coffetype = null;
    private CoffeeSize? coffesize = null;
    
    private int quantity = 0;
    private double price = 0;

    // ====================================================================
    // DEPENDENCY INJECTION - services provided by Blazor
    // ====================================================================
    
    /// <summary>
    /// [Inject] tells Blazor to automatically provide this service
    /// IWebHostEnvironment = gives access to file paths
    /// EXAM TIP: Use webHostEnvironment.ContentRootPath to get app folder
    /// </summary>
    [Inject]
    private IWebHostEnvironment webHostEnvironment { get; set; }

    /// <summary>
    /// NavigationManager = allows navigation to other pages
    /// EXAM TIP: Use NavigationManager.NavigateTo("/pageroute") to redirect
    /// </summary>
    [Inject]
    private NavigationManager NavigationManager { get; set; }

    // ====================================================================
    // OnRecord() - VALIDATES and SAVES data to CSV file
    // ====================================================================
    
    /// <summary>
    /// Called when user clicks "Record" button
    /// Process:
    /// 1. Clear old errors
    /// 2. Validate all fields
    /// 3. If valid, create object and save to CSV
    /// 4. Navigate to report page
    /// EXAM TIP: This is your standard "save" method pattern
    /// </summary>
    protected void OnRecord()
    {
        // STEP 1: Clear previous error messages
        errorMsgs.Clear();

        // ================================================================
        // STEP 2: VALIDATION - check each field and add error if invalid
        // ================================================================
        
        // Validate Order ID - cannot be empty
        if (string.IsNullOrEmpty(orderId))
        {
            errorMsgs.Add(1, "Order ID is required.");
        }
        
        // Validate Customer Name - cannot be empty
        if (string.IsNullOrEmpty(customerName))
        {
            errorMsgs.Add(2, "Customer Name is required.");
        }
        
        // Validate Coffee Type - must select from dropdown
        // .HasValue checks if nullable enum has been set
        if (!coffetype.HasValue)
        {
            errorMsgs.Add(3, "Coffee Type is required.");
        }
        
        // Validate Coffee Size - must select from dropdown
        if (!coffesize.HasValue)
        {
            errorMsgs.Add(4, "Coffee Size is required.");
        }
        
        // Validate Quantity - must be positive (> 0)
        // Uses Utilities class for validation
        if (!Utilities.IsNonZeroPositive(quantity))
        {
            errorMsgs.Add(5, "Quantity must be between 1 and 20.");
        }
        
        // Validate Price - must be in valid range ($0.01 - $100.00)
        // Uses Utilities class for validation
        if (!Utilities.IsValidPrice(price))
        {
            errorMsgs.Add(6, "Price must be between $0.01 and $100.00.");
        }

        // ================================================================
        // STEP 3: SAVE DATA if no validation errors
        // ================================================================
        if (errorMsgs.Count == 0)  // Count == 0 means no errors
        {
            try
            {
                // CREATE OBJECT from form data
                // .Value gets actual enum value from nullable enum
                // Constructor will do additional validation
                CoffeeOrder order = new CoffeeOrder(
                    orderId,
                    customerName,
                    coffetype.Value,    // .Value extracts enum from CoffeeType?
                    coffesize.Value,    // .Value extracts enum from CoffeeSize?
                    quantity,
                    price
                );

                // BUILD FILE PATH
                // ContentRootPath = C:\MyProject\
                // Result = C:\MyProject\Components\Data\GoodTestFile.csv
                // EXAM TIP: Use $@"" for file paths ($ for variables, @ for backslashes)
                string csvFilePathName = $@"{webHostEnvironment.ContentRootPath}/Components/Data/GoodTestFile.csv";

                // CONVERT OBJECT TO CSV STRING
                // order.ToString() returns: "ORD001,John,Espresso,Small,1,3.50"
                // \n adds new line at end
                string line = $"{order.ToString()}\n";

                // WRITE TO FILE
                // AppendAllText:
                // - Creates file if doesn't exist
                // - Opens file
                // - Writes text to END of file (append mode)
                // - Closes file
                // EXAM TIP: System.IO.File must be fully qualified (can't use "using System.IO;")
                System.IO.File.AppendAllText(csvFilePathName, line);

                // CLEAR FORM after successful save
                OnClear();

                // NAVIGATE to report page to see saved data
                NavigationManager.NavigateTo("/coffeshopreportrazor");
            }
            catch (ArgumentNullException ex)
            {
                // Catch errors from null/empty required fields
                errorMsgs.Add(7, $"Data Missing Error: {ex.Message}");
            }
            catch (ArgumentException ex)
            {
                // Catch validation errors from class (quantity out of range, etc.)
                errorMsgs.Add(8, $"Bad Data Error: {ex.Message}");
            }
            catch (Exception ex)
            {
                // Catch any other unexpected errors
                errorMsgs.Add(9, $"System Error: {ex.Message}");
            }
        }
    }

    // ====================================================================
    // OnClear() - RESETS form to empty state
    // ====================================================================
    
    /// <summary>
    /// Called when user clicks "Clear" button
    /// Resets all form fields to default empty values
    /// EXAM TIP: Remember to clear error messages too!
    /// </summary>
    protected void OnClear()
    {
        orderId = "";
        customerName = "";
        coffetype = null;      // null = "not selected" for dropdowns
        coffesize = null;
        quantity = 0;
        price = 0;
        errorMsgs.Clear();     // Remove all error messages
    }

    // ====================================================================
    // OnInitialized() - RUNS ONCE when page loads
    // ====================================================================
    
    /// <summary>
    /// Lifecycle method - called when component first initializes
    /// EXAM TIP: Always call base.OnInitialized() first!
    /// Use this for any setup needed when page loads
    /// </summary>
    protected override void OnInitialized()
    {
        base.OnInitialized();
        // Any initialization code goes here (none needed for this page)
    }

    // ====================================================================
    // OnReport() - NAVIGATES to report page
    // ====================================================================
    
    /// <summary>
    /// Called when user clicks "Report" button
    /// Redirects to report page to view saved orders
    /// </summary>
    protected void OnReport()
    {
        NavigationManager.NavigateTo("/coffeshopreportrazor");
    }
}


