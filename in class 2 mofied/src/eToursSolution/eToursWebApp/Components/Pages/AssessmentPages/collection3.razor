@page "/collection"
<PageTitle>Excursion Collection</PageTitle>
@rendermode InteractiveServer

@using eToursWebApp.Model;


<h1>Excursion Collection</h1>

<!--
    error message display area
    i show errors here if the user entered bad data
    using bootstrap alert styling to make it stand out
-->
@if (errorMsgs.Count > 0)
{
    <div class="alert alert-danger">
        <p><strong>Please fix the following issues:</strong></p>
        <ul>
            @foreach (var error in errorMsgs)
            {
                <!--
                errors are stored in a dictionary so each one has a unique key
                i only display the message part (the Value)
                -->
                <li>@error.Value</li>
            }
        </ul>
    </div>
}

<!--
    feedback message display area
    i show success messages here after the user saves data
-->
@if (feedBackMsg.Length > 0)
{
    <div class="alert alert-info">
        <p>@feedBackMsg</p>
    </div>
}

<!--
Activity 3

create the input form as shown in question (exact layout is not required)
use the enum class to create the select control

 public Excursion(string name, DateTime excursiondate, double duration, ExcursionType tourtype)
        {
            if (excursiondate < DateTime.Today)
            {
                throw new ArgumentException($"Excursion date {excursiondate} is invalid. Must be a date greater than today", "ExcurationDate");
            }
            Name = name;
            ExcursionDate = excursiondate;
            Duration = duration;
            TourType = tourtype;
        }
-->
<!--
    the form section
    this is where i let users enter all their excursion info
    using bootstrap for the layout
-->
<fieldset>
    <legend style="text-align: center;">Excursion Details</legend>

    <!-- excursion name input -->
    <!--
    user has to fill this in, i validate it when they submit
    -->
    <div class="row mb-3">
        <label class="col-md-3 col-form-label">Excursion Name</label>
        <div class="col-md-4">
            <input type="text" class="form-control"
                   @bind="name"
                   placeholder="enter name" />
        </div>
    </div>

    <!-- excursion date input -->
    <div class="row mb-3">
        <label class="col-md-3 col-form-label">Excursion Date</label>
        <div class="col-md-4">
            <input type="date" class="form-control"
                   @bind="excursiondate"
                   placeholder="" />
        </div>
    </div>

    <!-- excursion duration input -->
    <div class="row mb-3">
        <label class="col-md-3 col-form-label">Excursion Duration</label>
        <div class="col-md-4">
            <input type="number" class="form-control"
                   @bind="duration"
                   placeholder="eg. 3.5" />
        </div>
    </div>

    <!-- excursion type dropdown -->
    <div class="row mb-3">
        <label class="col-md-3 col-form-label">Excursion Type</label>
        <div class="col-md-4">
            <!--
            i use a dropdown so users can only pick from valid options
            this keeps bad data from being entered
            -->
            <select class="form-control" @bind="tourtype">
                <!--
                i loop through the ExcursionType enum and display each option
                the user picks one and i get that value back
                -->
                @foreach (var type in Enum.GetValues(typeof(ExcursionType)))
                {
                    <!-- each enum becomes an option in the dropdown -->
                    <option value="@type">@type</option>
                }
            </select>
        </div>
    </div>

    <!-- buttons at the bottom -->
    <div class="row">
        <div class="col-md-12 text-center">
            <!-- collect button validates and saves the data -->
            <button type="button" class="btn btn-primary"
                    @onclick="OnCollect">
                Submit
            </button>
            &nbsp;&nbsp;
            <!-- clear button resets the form -->
            <button type="button" class="btn btn-secondary"
                    @onclick="OnClear">
                Clear
            </button>
            &nbsp;&nbsp;
            <!-- schedule button takes you to the schedule page -->
            <button type="button" class="btn btn-success"
                    @onclick="OnSchedule">
                View Schedule
            </button>
        </div>
    </div>
</fieldset>

@code {
    // ============================================================
    // VARIABLES AND PROPERTIES
    // ============================================================

    // i use a dictionary to hold error messages
    // the key is a number so each error has a unique id
    // the value is the actual error message text
    private Dictionary<int, string> errorMsgs = new Dictionary<int, string>();

    // string to hold success feedback messages
    private string feedBackMsg = "";

    // ============================================================
    // DEPENDENCY INJECTION
    // ============================================================

    // service injection - this lets me access the web host environment to find file paths
    // i need this to get the ContentRootPath where my CSV file is stored
    [Inject]
    private IWebHostEnvironment webHostEnvironment { get; set; }

    // this lets me redirect the user to different pages
    // i use this to navigate to the schedule page after saving
    [Inject]
    private NavigationManager NavigationManager { get; set; }

    // this is for potential javascript interop (not used in this version)
    [Inject]
    private IJSRuntime jSRuntime { get; set; }

    // ============================================================
    // FORM VARIABLES
    // ============================================================
    // variables for holding the form data the user enters

    private string name = "";
    private DateTime excursiondate = DateTime.Today;
    private double duration = 0;
    private ExcursionType tourtype = ExcursionType.Walk;

    // ============================================================
    // LIFECYCLE METHODS
    // ============================================================

    protected override void OnInitialized()
    {
        // i call the base method to do the default setup stuff
        base.OnInitialized();

        // Activity 3
        // default excursion date to Today (already done in variable initialization)
        // but i could customize more stuff here if needed in the future
    }

    // ============================================================
    // BUTTON EVENT HANDLERS
    // ============================================================

    /// <summary>
    /// clear button event handler
    /// resets all form fields back to empty/default values
    /// </summary>
    private void OnClear()
    {
        // clearing all error messages from my dictionary
        errorMsgs.Clear();

        // clearing the feedback message
        feedBackMsg = "";

        // resetting all form fields back to empty/default
        name = "";
        excursiondate = DateTime.Today;
        duration = 0;
        tourtype = ExcursionType.Walk;
    }

    /// <summary>
    /// submit button event handler
    /// validates the form data and saves it to a CSV file
    /// uses dictionary for errors and boolean flags instead of return statements
    /// </summary>
    private void OnCollect()
    {
        // ============================================================
        // STEP 1: CLEAR PREVIOUS MESSAGES
        // ============================================================
        // clear out any old error messages and feedback first
        errorMsgs.Clear();
        feedBackMsg = "";

        // ============================================================
        // STEP 2: VALIDATE EACH FIELD
        // ============================================================
        // i check each field and add errors to the dictionary with unique keys
        // this is better than a list because i can track which validation failed

        // 1. validate excursion name - checking if it has data
        if (string.IsNullOrWhiteSpace(name))
        {
            errorMsgs.Add(1, "Excursion Name is required.");
        }

        // 2. validate excursion date - must be today or future
        if (excursiondate < DateTime.Today)
        {
            errorMsgs.Add(2, "Excursion Date must be today or a future date.");
        }

        // 3. validate duration - must be a positive number
        if (duration <= 0)
        {
            errorMsgs.Add(3, "Excursion Duration must be a positive number.");
        }

        // tourtype doesn't need validation because it's a dropdown with valid enum values

        // ============================================================
        // STEP 3: PROCESS DATA ONLY IF VALIDATION PASSED
        // ============================================================
        // instead of using 'return' to exit early, i use a boolean check
        // this makes the code flow clearer and avoids early exits

        // boolean flag to track if we should proceed with saving
        bool validationPassed = false;

        // if i got no errors, i can proceed with saving
        if (errorMsgs.Count == 0)
        {
            validationPassed = true;
        }

        if (validationPassed)
        {
            // ============================================================
            // STEP 4: TRY TO SAVE THE DATA
            // ============================================================
            // i use try-catch to handle any errors that might happen when creating or saving the data
            try
            {
                // ============================================================
                // STEP 4A: CREATE THE EXCURSION OBJECT
                // ============================================================
                // i create this object with all the form data in the constructor
                // the constructor validates everything again (business rules)
                // if anything is wrong it will throw an exception that i catch below
                // in this way i have two layers of validation: one here (UI) and one in the class (business logic)
                Excursion newExcursion = new Excursion(name, excursiondate, duration, tourtype);

                // ============================================================
                // STEP 4B: CONVERT TO CSV FORMAT
                // ============================================================
                // convert excursion object to CSV format using ToString() method
                string csvLine = newExcursion.ToString();


                // ============================================================
                // STEP 4C: BUILD THE FILE PATH
                // ============================================================
                // building the file path to save the data
                // i get the content root path from the injected IWebHostEnvironment service
                // this gives me the top folder of my application

                // getting the root path of the application
                string appPathName = webHostEnvironment.ContentRootPath;

                // building the full path to the csv file
                // WARNING: i use forward slashes (/) for cross-platform support (works on PC and Mac)
                string csvFilePathName = $@"{appPathName}/Data/eTourGood.csv";

                // alternative file paths for testing different scenarios:
                // string csvFilePathName = $@"{appPathName}/Data/eTourEmpty.csv";
                // string csvFilePathName = $@"{appPathName}/Data/eTourGoodBad.csv";
                // string csvFilePathName = $@"{appPathName}/Data/eTourNotThere.csv";


                // ============================================================
                // CSV WRITING METHODS - DIFFERENT APPROACHES
                // ============================================================

                // METHOD 1: File.AppendAllText (CURRENTLY USED) ✓
                // --------------------------------------------------------
                // Pros: Simple, one-line solution, automatically creates file if needed
                // Cons: Opens/closes file each time (slower for bulk writes)
                // Best for: Single record writes (like this form submission)
                // the System.IO.File method will be AppendAllText(filepathname, string)
                // AppendAllText will: a) create the file if it doesn't exist
                //                     b) opens the file
                //                     c) writes the text
                //                     d) closes the file
                System.IO.File.AppendAllText(csvFilePathName, csvLine + Environment.NewLine);


                // METHOD 2: StreamWriter with AppendText (COMMENTED)
                // --------------------------------------------------------
                // Pros: Better control, can write multiple lines efficiently
                // Cons: More verbose code
                // Best for: Writing multiple records at once
                // using (StreamWriter writer = System.IO.File.AppendText(csvFilePathName))
                // {
                //     writer.WriteLine(csvLine);
                //     // the 'using' statement ensures the file is properly closed
                //     // i could write multiple lines here if needed
                // }


                // METHOD 3: StreamWriter with custom buffer (COMMENTED)
                // --------------------------------------------------------
                // Pros: Maximum performance for large files
                // Cons: Overkill for small files, more complex
                // Best for: Writing huge amounts of data
                // using (StreamWriter writer = new StreamWriter(csvFilePathName, append: true, System.Text.Encoding.UTF8, 65536))
                // {
                //     writer.WriteLine(csvLine);
                //     // append: true means add to end (don't overwrite)
                //     // 65536 is the buffer size (64KB)
                // }


                // METHOD 4: File.WriteAllLines (COMMENTED)
                // --------------------------------------------------------
                // Pros: Can write entire collection at once
                // Cons: Overwrites file, need to read existing data first
                // Best for: Rewriting entire file with all excursions
                // List<string> allLines = new List<string>();
                // if (System.IO.File.Exists(csvFilePathName))
                // {
                //     allLines.AddRange(System.IO.File.ReadAllLines(csvFilePathName));
                // }
                // allLines.Add(csvLine);
                // System.IO.File.WriteAllLines(csvFilePathName, allLines);


                // ============================================================
                // NEWLINE OPTIONS (FOR EDUCATIONAL REFERENCE)
                // ============================================================
                // Option 1: Environment.NewLine (RECOMMENDED - WHAT I'M USING) ✓
                // - Cross-platform compatible (Windows: \r\n, Mac/Linux: \n)

                // Option 2: "\n" (ALTERNATIVE)
                // - System.IO.File.AppendAllText(csvFilePathName, csvLine + "\n");

                // Option 3: "\r\n" (WINDOWS SPECIFIC)
                // - System.IO.File.AppendAllText(csvFilePathName, csvLine + "\r\n");


                // ============================================================
                // STEP 5: SUCCESS - SHOW MESSAGE AND CLEAR FORM
                // ============================================================
                // talk to the user - let them know the save was successful
                feedBackMsg = "Excursion saved successfully!";

                // clearing the form after successful save
                // this is better UX - user can immediately enter another excursion
                name = "";
                excursiondate = DateTime.Today;
                duration = 0;
                tourtype = ExcursionType.Walk;

                // OPTIONAL: redirect to schedule page to see the saved data
                // uncomment the line below if you want automatic redirect after save
                // NavigationManager.NavigateTo("/schedule");

            }
            catch (ArgumentNullException ex)
            {
                // ============================================================
                // STEP 6A: HANDLE NULL ERRORS
                // ============================================================
                // this happens if required fields are missing (caught by the class constructor)
                // i add this to the error dictionary with key 10
                errorMsgs.Add(10, $"Data Missing Error: {ex.Message}");
            }
            catch (ArgumentException ex)
            {
                // ============================================================
                // STEP 6B: HANDLE VALIDATION ERRORS
                // ============================================================
                // this happens if validation fails in the class constructor
                // (e.g., date in the past, negative duration)
                errorMsgs.Add(11, $"Bad Data Error: {ex.Message}");
            }
            catch (Exception ex)
            {
                // ============================================================
                // STEP 6C: HANDLE ANY OTHER ERRORS
                // ============================================================
                // catching any other unexpected errors (file access issues, etc.)
                // get the innermost exception for clearer error message
                Exception innerEx = GetInnerException(ex);
                errorMsgs.Add(12, $"System Error: {innerEx.Message}");
            }
        }
        // if validationPassed is false, we skip the entire if block above
        // and the method ends naturally without needing 'return'
        // the error messages will automatically display at the top of the page
    }

    /// <summary>
    /// view schedule button event handler
    /// redirects the user to the schedule page to see all saved excursions
    /// </summary>
    protected void OnSchedule()
    {
        // navigate to the schedule page using the NavigationManager service
        // this is dependency injection - blazor provides this service automatically
        // forceLoad: false means we stay within the blazor app (default behavior)
        // if i wanted to go to an external website, i would use forceLoad: true
        NavigationManager.NavigateTo("/schedule");
    }

    // ============================================================
    // HELPER METHODS
    // ============================================================

    /// <summary>
    /// helper method to unwrap nested exceptions
    /// finds the original/root exception that caused the error
    /// this gives us the most specific and helpful error message
    /// </summary>
    private Exception GetInnerException(Exception ex)
    {
        // some exceptions wrap other exceptions (InnerException property)
        // i loop until i find the deepest one (the real cause)
        while (ex.InnerException != null)
            ex = ex.InnerException;
        return ex;
    }
}
