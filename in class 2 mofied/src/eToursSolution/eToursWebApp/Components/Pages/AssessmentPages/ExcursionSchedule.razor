@page "/schedule"
<PageTitle>Excursion Schedule</PageTitle>
@rendermode InteractiveServer

@using eToursWebApp.Model

<h1>Excursion Schedule</h1>

@if (feedBackMsg.Length > 0)
{
    <div class="alert alert-info">
        <p>@feedBackMsg</p>
    </div>
}

@if (errorMsgs.Count > 0)
{
    <div class="alert alert-danger">
        <p>Please fix the following issues:</p>
        <ul>
            @foreach (var error in errorMsgs)
            {
                <li>@error</li>
            }
        </ul>
    </div>
}
@if (!fileExists)  // ← Check: Does file NOT exist?
{
    <div class="alert alert-warning text-center">
        <p>No file has been loaded. Please check the file path.</p>
    </div>
}
else if (excursions.Count == 0)  // ← Check: Is it empty?
{
    <div class="alert alert-info text-center">
        <p>The excursion file is empty. No data to display.</p>
    </div>

}
else
{

    <div class="row">
        <div class="col-md-10 offset-md-1">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Excursion Date</th>
                        <th>Duration (hours)</th>
                        <th>Tour Type</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var excursion in excursions)
                    {
                        <tr>
                            <td>@excursion.Name</td>
                            <td>@excursion.ExcursionDate.ToString("MMM dd, yyyy")</td>
                            <td>@excursion.Duration</td>
                            <td>@excursion.TourType</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
}

<!--
    Activity 2
    create a table display for the data, see image in question for layout
    create separate messages if a) the data file does not exist and 
                                b) the data file exists but is empty 


            @*                      Name = name;
            ExcursionDate = excursiondate;
            Duration = duration;
            TourType = tourtype; *@
-->
@code {


    private string feedBackMsg = "";
    private List<string> errorMsgs = new List<string>();
    //list to hold excursions 
    private List<Excursion> excursions = new List<Excursion>();
    private bool fileExists = false;  // Start: assume file doesn't exist

    protected override void OnInitialized()
    {
        base.OnInitialized();
        string filename = @"./Data/eTourGood.csv";
        // string filename = @"./Data/eTourEmpty.csv";
        //string filename = @"./Data/eTourGoodBad.csv";
        // string filename = @"./Data/eTourNotThere.csv";

        //Activity 2

        //write the code to 
        //  a) read the file
        //  b) place the records in a collection to display in the table above
        //  c) user friendly error handling is required.
        //  d) all records in the file must be handled, processed as good or bad

        // Step 1: Check if file exists
        if (!System.IO.File.Exists(filename))
        {
            fileExists = false;  // Set flag
            errorMsgs.Add("System Error: File does not exist.");
            return;  // Stop here

        }
        fileExists = true;
        // Step 2: Read all lines from the file
        string[] lines = System.IO.File.ReadAllLines(filename);


        //step 3 check if file is empty 
        if (lines.Length == 0)
        {
            feedBackMsg = "The excursion file is empty. No data to display.";
            return;
        }
        // Step 4: Loop through each line and parse i
        foreach (string line in lines)
        {

            try
            {
                // Try to parse the line into an Excursion object
                Excursion excursion = Excursion.Parse(line);
                // Success! Add it to the list
                    excursions.Add(excursion);

            }
            catch (Exception ex)
            {
                Exception innerEx = GetInnerException(ex);
                errorMsgs.Add($"Error on record: {innerEx.Message}");

            }
        }
        // Step 5: Show success message if we loaded any excursions
            if (excursions.Count > 0)
            {
                feedBackMsg = $"Successfully loaded {excursions.Count} excursion(s).";
            }

    }

    

    private Exception GetInnerException(Exception ex)
    {
        while (ex.InnerException != null)
            ex = ex.InnerException;
        return ex;
    }
}
