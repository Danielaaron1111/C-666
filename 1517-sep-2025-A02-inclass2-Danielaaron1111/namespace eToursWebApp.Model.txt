namespace eToursWebApp.Model
{
    public class Excursion
    {
        private string _Name;
        private double _Duration;
        public string Name
        {
            get { return _Name; }
            set
            {
                if(string.IsNullOrWhiteSpace(value))
                {
                    throw new ArgumentNullException("Name", "Name is required. Cannot be empty.");
                }
                _Name =value;
            }
        }

        public DateTime ExcursionDate { get; set; }

        public double Duration
        {
            get { return _Duration; }
            set
            {
                if (value < 0)
                {
                    throw new ArgumentException($"Duration {value} is invalid. Must be greater than 0.","Duration");
                }
                _Duration = value;
            }
        }

        public ExcursionType TourType { get; set; }

        public Excursion(string name, DateTime excursiondate, double duration, ExcursionType tourtype)
        {
            if (excursiondate < DateTime.Today) //i already did the correction here
            {
                throw new ArgumentException($"Excursion date {excursiondate} is invalid. Must be a date greater than today", "ExcurationDate");
            }
            Name = name;
            ExcursionDate = excursiondate;
            Duration = duration;
            TourType = tourtype;
        }

        public override string ToString()
        {
            return $"{Name},{ExcursionDate.ToString("MMM-dd-yyyy")},{Duration},{TourType}";
        }

        public static Excursion Parse(string text)
        {
            if (string.IsNullOrWhiteSpace(text))
            {
                throw new ArgumentNullException("ParseString", "No data present to Parse.");
            }
            string[] items = text.Split(',');
            if (items.Length != 4)
            {
                throw new FormatException($"Data string is invalid. Insufficent/Excessive string values. Data: {text}");
            }
            return new Excursion(items[0],
                                 DateTime.Parse(items[1]),
                                 double.Parse(items[2]),
                                 Enum.Parse<ExcursionType>(items[3]));
        }
    }
}



namespace eToursWebApp.Model
{
    public enum ExcursionType
    {
        Walk,
        BusTour,
        Bike,
        Water,
        Dive,
        Moped
    }
}


googatacsv: Cancun Shopping,Mar-16-2027,5.5,Walk
Cancun Shopping,Mar-17-2027,5.5,Walk
Cancun Shopping,Mar-18-2027,5.5,Walk
SeaLife Sites,Mar-16-2027,6.0,Dive
Acient Lives,Mar-12-2028,9.5,BusTour
Acient Lives,Mar-19-2028,9.5,BusTour
Acient Lives,Mar-26-2028,9.5,BusTour
Acient Lives,Apr-02-2028,9.5,BusTour
More Than Tequila,Jun-07-2028,8.5,BusTour
Them Darn Trails,Jul-23-2027,5.5,Moped
Water Games,Jul-12-2026,7.5,Water


baddatacsv: Cancun Shopping,Mar-16-2027,5.5,Walk
Cancun Shopping,Mar-17-2027,5.5,Walk
Cancun Shopping,Mar-18-2024,5.5,Walk
SeaLife Sites,Mar-16-2027,6.0,Dive
Acient Lives,9.5,BusTour
Acient Lives,Mar-19-2028,9.5,BusTour
Acient Lives,Mar-26-2028,9.5,BusTour,too many
,Apr-02-2028,9.5,BusTour
More Than Tequila,Jun-07-2028,8.5,BusTour
Them Darn Trails,Jul-23-2027,-5.5,Moped
Water Games,Jul-12-2026,7.5,Water

@page "/collection"
<PageTitle>Excursion Collection</PageTitle>
@rendermode InteractiveServer

@using eToursWebApp.Model;


<h1>Excursion Collection</h1>

@if (feedBackMsg.Length > 0)
{
    <div class="alert alert-info">
        <p>@feedBackMsg</p>
    </div>
}

@if (errorMsgs.Count > 0)
{
    <div class="alert alert-danger">
        <p>Please fix the following issues:</p>
        <ul>
            @foreach (var error in errorMsgs)
            {
                <li>@error</li>
            }
        </ul>
    </div>
}

<!-- 
Activity 3

create the input form as shown in question (exact layout is not required)
use the enum class to create the select control

-->
@* Create the mockup form image shown below. Do not use EditForm.
Validate all data. This should be done in the event method.
Add any necessary properties/variables to the page for your form.
Collect and display all possible errors at one time. An area to display a summary of errors has already been placed on the page.
Append the data to the good csv file located in the Data folder if the data passes validation. *@
<fieldset>
    <div class="row">
        <div class="offset-4 col-md-2">
            <label for="title">Excursion Name</label>
        </div>
        <div class="col-md-2">
            <input type="text" id="excursionname" placeholder="enter name"
                   @bind="excursionname" />
        </div>
    </div>

    <div class="row">
        <div class=" offset-4 col-md-2">
            <label for="years">Excursion duration in hours</label>
        </div>
        <div class="col-md-2">
           
            <input type="number" id="years" placeholder="eg 3.4" style="width:75px;"
                   step="0.1" @bind="excursionDuration" />
        </div>
    </div>

    <div class="row">
        <div class=" offset-4 col-md-2">
            <label for="startdate">Excursion Date</label>
        </div>
        <div class="col-md-2">
            <input type="date" id="startdate"
                   @bind="excursionDate" />
        </div>
    </div>

    <select id="levels" @bind="excursiontypee">
      
        @foreach (var item in Enum.GetValues(typeof(ExcursionType)))
        {
            
            <option value="@item">@item</option>
        }
    </select>
    <br />
    <div class="row">
        <div class="col-md-12 text-center">
            <button type="submit" class="btn btn-outline-primary rounded-pill"
                    @onclick="OnCollect">
                Submit
            </button>
            &nbsp;&nbsp
            <button type="submit" class="btn btn-outline-secondary rounded-pill"
                    @onclick="OnClear">
                Clear
            </button>

        </div>
    </div>

</fieldset>





@code {
    private string feedBackMsg = "";
    private List<string> errorMsgs = new List<string>();

    [Inject]
    private IJSRuntime? jSRuntime { get; set; }

    // Activity 3

    // add any require variables to process your form
    private string excursionname = "";
    private double excursionDuration = 0;
    private DateTime excursionDate = DateTime.Today;
    private ExcursionType excursiontypee = ExcursionType.Walk; //default value 

    protected override void OnInitialized()
    { 
        base.OnInitialized();
        // Activity 3

        // default excursion date to Today
        excursionDate = DateTime.Today;
    }

    private Exception GetInnerException(Exception ex)
    {
        while (ex.InnerException != null)
            ex = ex.InnerException;
        return ex;
    }

    //Activity 3

    // add needed event method for collecting, validating and saving data.
    // i forget to add the saving file part but there is some code here to validate the form


    protected void OnCollect()
    {
        feedBackMsg = "";
        errorMsgs.Clear();

        if (string.IsNullOrWhiteSpace(excursionname))
        {
            errorMsgs.Add("Excursion name cannot be empty.");
        }

        if (excursionDuration <= 0)
        {
            errorMsgs.Add("Duration must be a non-zero positive value.");
        }

        if (excursionDate < DateTime.Today)
        {
            errorMsgs.Add("Excursion date cannot be in the past.");
        }

        if (errorMsgs.Count == 0)
        {
            feedBackMsg = "Excursion data collected successfully!";
        }
    }

    protected void OnClear()
    {
        excursionname = "";
        excursionDuration = 0;
        excursionDate = DateTime.Today;
        excursiontypee = ExcursionType.Walk; //i initialize to default value
    }






    // add needed event method to clear the form

   
}


@page "/schedule"
<PageTitle>Excursion Schedule</PageTitle>
@rendermode InteractiveServer

@using eToursWebApp.Model

<h1>Excursion Schedule</h1>

@if (feedBackMsg.Length > 0)
{
    <div class="alert alert-info">
        <p>@feedBackMsg</p>
    </div>
}

@if (errorMsgs.Count > 0)
{
    <div class="alert alert-danger">
        <p>Please fix the following issues:</p>
        <ul>
            @foreach (var error in errorMsgs)
            {
                <li>@error</li>
            }
        </ul>
    </div>
}

<!--
    Activity 2
    create a table display for the data, see image in question for layout
    create separate messages if a) the data file does not exist and 
                                b) the data file exists but is empty 
-->
@if (excursions == null)
{
    @* a *@
    <div class="row alert alert-info text-center">
        <p>Open an employment history file</p>
    </div>
}
else if (excursions.Count == 0)
{
    @* b *@
    <div class="row alert alert-info text-center">
        <p>Employment history file is empty, no data.</p>
    </div>
}
else
{
    <div class="row">
        <div class="offset-2 col-md-8 overflow-scroll" style="height:450px">
            <table class="table table-striped">
                <thead style="position:sticky; top: 0; background-color:white;">
                    <tr>
                        <th>Name</th>
                        <th>Excursion Date</th>
                        <th>Duration</th>
                        <th>Tour Type</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var excursionRow in excursions)
                    {
                        <tr>
                            <td>@excursionRow.Name</td>
                            <td>@excursionRow.ExcursionDate.ToString("MMM dd, yyyy")</td>
                            <td>@excursionRow.Duration</td>
                            <td>@excursionRow.TourType</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
}
@if (!string.IsNullOrWhiteSpace(feedBackMsg))
{
    <div class="row alert alert-success text-center">
        <p>@feedBackMsg</p>
    </div>
}

@if (errorMsgs.Count > 0)
{
    <div class="row alert alert-danger">
        <p>Please fix the following issues:</p>
        <ul>
            @foreach (var error in errorMsgs)
            {
                <!--
                This is a List collection
                there is only one component, the string
                therefore you would NOT need the .Value
                -->
                <li>@error</li>
            }
        </ul>
    </div>
}

@code {
    private string feedBackMsg = "";
    private List<string> errorMsgs = new List<string>();
    private List<Excursion> excursions;
    

    protected override void OnInitialized()
    {
        base.OnInitialized();

        //test files for assessment

        // string filename = @"./Data/eTourGood.csv";
        // string filename = @"./Data/eTourEmpty.csv";
        string filename = @"./Data/eTourGoodBad.csv";
        // string filename = @"./Data/eTourNotThere.csv";

        //Activity 2

        //write the code to 
        //  a) read the file
        //  b) place the records in a collection to display in the table above
        //  c) user friendly error handling is required.
        //  d) all records in the file must be handled, processed as good or bad

        Reading(filename);
    }
    private void Reading(string filename)
    {
        excursions = new List<Excursion>();
        errorMsgs.Clear();
        feedBackMsg = "";
        try
        {
            if (System.IO.File.Exists(filename))
            {
                excursions = new();
                string[] userdata = System.IO.File.ReadAllLines(filename);

                foreach (string line in userdata)
                {
                    try
                    {
                        Excursion excursion = Excursion.Parse(line);
                        excursions.Add(excursion);
                    }
                    catch (Exception ex)
                    {
                        errorMsgs.Add($"Error parsing record: {GetInnerException(ex).Message}");
                    }
                }

                if (excursions.Count > 0)
                {
                    feedBackMsg = $"Successfully loaded {excursions.Count} excursion(s).";
                }
            }
            else
            {
                errorMsgs.Add($"System Error: File {filename} does not exist.");
            }
        }
        //id add this but not sure if its needed we have not seen this getinnerexpection before
        catch (Exception ex)
        {
            errorMsgs.Add($"System Error: {GetInnerException(ex).Message}");
        }
    }

    //DO WE HAVE TO ADD TE INNER EXEPTION METHOD AGAIN???? 
    private Exception GetInnerException(Exception ex)
    {
        while (ex.InnerException != null)
            ex = ex.InnerException;
        return ex;
    }
}


    
            